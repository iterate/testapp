<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8" />

        <title>Testapp</title>

        <style>
            input {
                display: block;
                margin-bottom: 16px;
            }
            label {
                display: block;
            }
        </style>
    </head>

    <body>
        <div id="messages"></div>
        <form action="#" id="sendform"><input id="message" /><button>Send</button></form>
    </body>

    <script>
        async function reload() {
            let res = await fetch('/api/messages');
            if (!res.ok) {
                throw Error(`${res.status}: ${res.statusText}`);
            }
            let data = await res.json();

            let parent = document.getElementById('messages');
            parent.innerHTML = '';
            data.forEach(({ text }) => {
                let div = document.createElement('div');
                div.innerText = text;
                parent.appendChild(div);
            });
        }

        async function onSubmit(event) {
            event.preventDefault();
            let input = document.getElementById('message');
            let message = input.value;
            let res = await fetch('/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message }),
            });
            if (!res.ok) {
                throw Error(`${res.status}: ${res.statusText}`);
            }
            input.value = '';
            await reload();
        }

        async function main() {
            document.getElementById('sendform').addEventListener('submit', event => {
                onSubmit(event).catch(console.error);
            });

            await reload();

            setInterval(() => {
                reload().catch(console.error);
            }, 2000);
        }

        main().catch(console.error);
    </script>
</html>
